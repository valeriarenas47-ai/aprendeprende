<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simulador de Creación de Empresa — 12 meses con IVA</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--accent:#22c55e;--accent2:#3b82f6;--danger:#ef4444}
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b1023,#0f172a);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#e5e7eb}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:16px}
    h1{font-size:clamp(20px,3.4vw,34px);margin:0;font-weight:800;letter-spacing:.3px}
    .pill{font-size:12px;color:#0b1023;background:linear-gradient(90deg,var(--accent),var(--accent2));padding:6px 10px;border-radius:999px;font-weight:700}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:1100px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,#0f172a,#0b1224);border:1px solid #1f2937;border-radius:18px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.45)}
    .card h2{margin:0 0 12px;font-size:18px}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-12{grid-column:span 12}
    label{display:block;font-size:12px;color:var(--muted);margin:2px 0 6px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #243046;background:#0b1120;color:#e5e7eb}
    input:focus,select:focus,textarea:focus{outline:2px solid #1f3a8a;border-color:#1f3a8a}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    button{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b1023}
    .ghost{background:transparent;border:1px solid #334155;color:#cbd5e1}
    .bad{background:var(--danger)}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px}
    .kpi{background:#0b1120;border:1px solid #1f2937;border-radius:16px;padding:12px}
    .kpi h3{margin:0 0 4px;font-size:12px;color:var(--muted)}
    .kpi .v{font-size:20px;font-weight:800}
    .table{overflow:auto;border-radius:12px;border:1px solid #1f2937}
    table{width:100%;border-collapse:collapse;min-width:1100px}
    th,td{padding:10px 12px;border-bottom:1px solid #1f2937;text-align:right}
    th:first-child,td:first-child{text-align:left}
    tr:hover td{background:rgba(59,130,246,.06)}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    .varyGrid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
    @media (max-width:700px){.varyGrid{grid-template-columns:repeat(3,1fr)}}
    .mini{font-size:11px}
    footer{margin-top:18px;color:#94a3b8;font-size:12px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Simulador de Creación de Empresa</h1>
      <span class="pill">Netlify‑ready • 12 meses</span>
    </header>

    <div class="grid">
      <!-- Panel de parámetros -->
      <section class="card" aria-labelledby="paramsTitle">
        <h2 id="paramsTitle">Parámetros del modelo</h2>
        <div class="row">
          <div class="col-4">
            <label>Precio de venta por unidad (sin IVA) ($)</label>
            <input type="number" id="precio" value="12000" min="0" step="100">
          </div>
          <div class="col-4">
            <label>IVA (% sobre ventas)</label>
            <input type="number" id="iva" value="19" min="0" max="100" step="0.1">
          </div>
          <div class="col-4">
            <label>Costo variable por unidad ($)</label>
            <input type="number" id="cvu" value="6000" min="0" step="100">
          </div>
          <div class="col-4">
            <label>Costos fijos mensuales ($)</label>
            <input type="number" id="cf" value="800000" min="0" step="1000">
          </div>
          <div class="col-4">
            <label>Demanda base (u/mes)</label>
            <input type="number" id="q0" value="200" min="0" step="1">
          </div>
          <div class="col-4">
            <label>Inversión inicial ($)</label>
            <input type="number" id="capex" value="3000000" min="0" step="10000">
          </div>
          <div class="col-4">
            <label>Tasa de impuesto a la renta (% utilidad)</label>
            <input type="number" id="tax" value="10" min="0" max="100" step="1">
          </div>
          <div class="col-4">
            <label>Depreciación mensual ($ opcional)</label>
            <input type="number" id="dep" value="50000" min="0" step="1000">
          </div>
          <div class="col-6">
            <label>Modo de variación de demanda (12 meses)</label>
            <select id="modo">
              <option value="pct">Porcentaje mensual respecto a la base (%)</option>
              <option value="abs">Unidades manuales (override)</option>
            </select>
          </div>
          <div class="col-6 actions">
            <button class="ghost" id="btnEstacional">Plantilla estacional (12m)</button>
            <button class="ghost" id="btnLimpiar">Limpiar variaciones</button>
          </div>
          <div class="col-12 note">
            <strong>Importante:</strong> Se eliminó el crecimiento de demanda. La demanda varía solo mediante los valores mensuales (12 meses).
            En modo "%" se aplica un ajuste sobre la demanda base (Q0). En modo "Unidades manuales" se ingresa la cantidad exacta por mes.
          </div>
        </div>

        <div class="kpis" id="kpis">
          <div class="kpi"><h3>Margen de contribución</h3><div class="v" id="mc">—</div></div>
          <div class="kpi"><h3>Punto de equilibrio (u/mes)</h3><div class="v" id="peu">—</div></div>
          <div class="kpi"><h3>Mes de payback</h3><div class="v" id="payback">—</div></div>
          <div class="kpi"><h3>Ganancia neta total</h3><div class="v" id="utn">—</div></div>
        </div>
      </section>

      <!-- Gráfico -->
      <section class="card">
        <h2>Gráfico: Flujo acumulado, utilidad y unidades</h2>
        <canvas id="chart" height="150"></canvas>
        <div class="note">El flujo acumulado parte en negativo por la inversión inicial. El payback ocurre cuando cruza 0.</div>
      </section>

      <!-- Variaciones por mes -->
      <section class="card col-12">
        <h2>Variaciones mensuales de la demanda</h2>
        <div class="note">Edita los valores para cada mes. En modo "%" usa positivos/negativos (p. ej. 10 o -5). En modo "Unidades manuales" ingresa la cantidad exacta.</div>
        <div id="variaciones" class="varyGrid"></div>
        <div class="actions" style="margin-top:10px">
          <button class="primary" id="run">Simular</button>
          <button class="ghost" id="exportCSV">Exportar CSV</button>
          <button class="ghost" id="importCSV">Importar CSV</button>
          <input type="file" id="fileInput" accept=".csv" style="display:none" />
        </div>
      </section>

      <!-- Tabla -->
      <section class="card col-12">
        <h2>Detalle mensual</h2>
        <div class="table">
          <table id="tabla">
            <thead>
              <tr>
                <th>Mes</th>
                <th>Base (u)</th>
                <th>Ajuste</th>
                <th>Unidades finales</th>
                <th>Ingresos (sin IVA)</th>
                <th>IVA ventas</th>
                <th>Ingresos + IVA</th>
                <th>Costos variables</th>
                <th>Margen</th>
                <th>Costos fijos</th>
                <th>Depreciación</th>
                <th>UAI</th>
                <th>Impuesto renta</th>
                <th>Ganancia neta</th>
                <th>Flujo</th>
                <th>Flujo acumulado</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="note">Nota: El IVA se muestra para referencia (ventas). Por defecto no afecta la utilidad ni el flujo, ya que se trata de un impuesto indirecto trasladado (débito/crédito no modelado aquí).</div>
      </section>
    </div>

    <footer>
      Sitio estático para Netlify. Sin backend. Puedes clonar este archivo como <code>index.html</code> y desplegar.
    </footer>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const nf = new Intl.NumberFormat('es-CL');
    const money = (x)=>`$${nf.format(Math.round(x||0))}`;
    let chart;

    function leerParams(){
      return {
        precio: +$('precio').value||0,      // precio sin IVA
        iva: (+$('iva').value||0)/100,      // tasa IVA
        cvu: +$('cvu').value||0,
        cf: +$('cf').value||0,
        q0: +$('q0').value||0,
        capex: +$('capex').value||0,
        tax: (+$('tax').value||0)/100,
        meses: 12,                          // fijo a 12 meses
        dep: +$('dep').value||0,
        modo: $('modo').value
      };
    }

    // --- Variaciones ---
    let variaciones = new Array(12).fill(0); // por mes, % o unidades según modo

    function construirGridVariaciones(){
      const p = leerParams();
      const cont = $('variaciones');
      cont.innerHTML='';
      // asegurar 12 entradas
      variaciones = variaciones.slice(0,12);
      while(variaciones.length<12) variaciones.push(0);
      for(let m=1;m<=12;m++){
        const wrap = document.createElement('div');
        const lab = document.createElement('label');
        lab.className='mini';
        lab.textContent = `Mes ${m}`;
        const inp = document.createElement('input');
        inp.type='number';
        inp.step = p.modo==='pct'? '0.1':'1';
        inp.value = variaciones[m-1] ?? 0;
        inp.addEventListener('input',()=>{ variaciones[m-1]=+inp.value||0; });
        wrap.appendChild(lab); wrap.appendChild(inp);
        cont.appendChild(wrap);
      }
    }

    function plantillaEstacional(){
      // 12 meses: ligera alza fin de año, baja en invierno
      const pattern = [5,3,2,0,-2,-6,-3,-1,0,2,4,8];
      for(let i=0;i<12;i++){
        variaciones[i] = pattern[i];
      }
      construirGridVariaciones();
    }

    function exportarCSV(){
      const p = leerParams();
      const {rows} = simular(p);
      let filas = ['Mes,Base,Modo,Ajuste,UnidadesFinales,IngresosSinIVA,IVAVentas,IngresosConIVA,CostosVariables,Margen,CostosFijos,Depreciacion,UAI,ImpuestoRenta,GananciaNeta,Flujo,FlujoAcumulado'];
      rows.forEach(r=>{
        filas.push([
          r.m, Math.round(r.qBase), p.modo, r.ajuste, Math.round(r.q),
          r.ingresos, r.ivaVentas, r.ingresosConIVA, r.cv, r.margen, r.cf, r.dep, r.uai, r.imp, r.un, r.flujo, r.flujoAcum
        ].join(','));
      });
      const blob = new Blob([filas.join('\\n')],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download='simulacion_12m_iva.csv'; a.click(); URL.revokeObjectURL(url);
    }

    function importarCSV(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        const lines = reader.result.split(/\\r?\\n/).filter(Boolean);
        const vals=[];
        for(let i=1;i<lines.length;i++){
          const cols = lines[i].split(',');
          if(cols.length>3){
            const adj = parseFloat(cols[3]);
            if(!isNaN(adj)) vals.push(adj);
          }
        }
        if(vals.length){ variaciones = vals.slice(0,12); construirGridVariaciones(); }
      };
      reader.readAsText(file);
    }

    // --- Cálculos ---
    function simular(p){
      const rows=[]; let flujoAcum = -p.capex; let gananciaNetaTotal=0; let paybackMes = null;
      for(let m=1;m<=12;m++){
        const qBase = Math.max(0, p.q0); // sin crecimiento
        const adj = + (variaciones[m-1] || 0);
        let qFinal;
        if(p.modo==='pct') qFinal = Math.max(0, qBase*(1+adj/100));
        else qFinal = Math.max(0, adj); // unidades manuales

        const ingresos = p.precio*qFinal;            // sin IVA
        const ivaVentas = ingresos * p.iva;          // referencia
        const ingresosConIVA = ingresos + ivaVentas; // referencia

        const cv = p.cvu*qFinal;
        const margen = ingresos - cv;                // margen de contribución total (sin IVA)
        const uai = margen - p.cf - p.dep;           // utilidad antes de impuestos
        const imp = Math.max(0, uai)*p.tax;          // solo si hay UAI positiva
        const un = uai - imp;                        // ganancia neta
        const flujo = un + p.dep;                    // flujo (depreciación se suma de vuelta)
        flujoAcum += flujo;
        if(paybackMes===null && flujoAcum>=0) paybackMes=m;
        gananciaNetaTotal += un;
        rows.push({m,qBase,q:qFinal,ajuste:adj,ingresos,ivaVentas,ingresosConIVA,cv,margen,cf:p.cf,dep:p.dep,uai,imp,un,flujo,flujoAcum});
      }
      return {rows, gananciaNetaTotal, paybackMes};
    }

    function puntoEquilibrioUnidades(p){
      const mcUnit = p.precio - p.cvu; // margen contribución unitario
      if(mcUnit<=0) return Infinity;
      return p.cf / mcUnit;
    }

    function actualizarUI(p, res){
      // KPIs
      const mcUnit = p.precio - p.cvu;
      $('mc').textContent = `${money(mcUnit)} por unidad`;
      const peu = puntoEquilibrioUnidades(p);
      $('peu').textContent = Number.isFinite(peu)? nf.format(Math.ceil(peu)) : 'No alcanza (margen ≤ 0)';
      $('payback').textContent = res.paybackMes ? `Mes ${res.paybackMes}` : 'No se recupera';
      $('utn').textContent = money(res.gananciaNetaTotal);

      // Tabla
      const tb = $('tabla').querySelector('tbody');
      tb.innerHTML = '';
      res.rows.forEach(r=>{
        const tr=document.createElement('tr');
        const c = (v)=>{const td=document.createElement('td');td.textContent=v;return td};
        tr.append(
          c(r.m),
          c(nf.format(Math.round(r.qBase))),
          c(p.modo==='pct'? (r.ajuste.toFixed(1)+'%') : nf.format(Math.round(r.ajuste))),
          c(nf.format(Math.round(r.q))),
          c(money(r.ingresos)),
          c(money(r.ivaVentas)),
          c(money(r.ingresosConIVA)),
          c(money(r.cv)),
          c(money(r.margen)),
          c(money(r.cf)),
          c(money(r.dep)),
          c(money(r.uai)),
          c(money(r.imp)),
          c(money(r.un)),
          c(money(r.flujo)),
          c(money(r.flujoAcum))
        );
        tb.appendChild(tr);
      });

      // Gráfico
      const labels = res.rows.map(r=>`Mes ${r.m}`);
      const flujos = res.rows.map(r=>r.flujo);
      const acumulado = res.rows.map(r=>r.flujoAcum);
      const unidades = res.rows.map(r=>r.q);
      const ctx = $('chart').getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx,{
        type:'line',
        data:{labels,datasets:[
          {label:'Flujo acumulado', data:acumulado, tension:.25, yAxisID:'y'},
          {label:'Utilidad/Flujo del mes', data:flujos, tension:.25, yAxisID:'y'},
          {label:'Unidades', data:unidades, tension:.25, yAxisID:'y2'}
        ]},
        options:{
          responsive:true,
          scales:{
            y:{position:'left', ticks:{callback:(v)=>money(v)}},
            y2:{position:'right', grid:{display:false}, ticks:{callback:(v)=>nf.format(v)}}
          },
          plugins:{legend:{labels:{boxWidth:12,usePointStyle:true}}}
        }
      });
    }

    function correr(){
      const p = leerParams();
      const res = simular(p);
      actualizarUI(p,res);
    }

    // Eventos
    $('run').addEventListener('click', correr);
    $('modo').addEventListener('change', ()=>{ construirGridVariaciones(); });
    $('btnEstacional').addEventListener('click', ()=>{ plantillaEstacional(); });
    $('btnLimpiar').addEventListener('click', ()=>{ variaciones = variaciones.map(()=>0); construirGridVariaciones(); });
    $('exportCSV').addEventListener('click', exportarCSV);
    $('importCSV').addEventListener('click', ()=>{ $('fileInput').click(); });
    $('fileInput').addEventListener('change', (e)=>{ if(e.target.files?.[0]) importarCSV(e.target.files[0]); });

    // Inicialización
    construirGridVariaciones();
    correr();
  </script>
</body>
</html>
